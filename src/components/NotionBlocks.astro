---
import * as interfaces from "src/lib/interfaces";
import { isTweetURL, isAmazonURL, buildURLToHTMLMap } from "@/lib/blog-helpers";
import Paragraph from "./notion-blocks/Paragraph.astro";
import Heading1 from "./notion-blocks/Heading1.astro";
import Heading2 from "./notion-blocks/Heading2.astro";
import Heading3 from "./notion-blocks/Heading3.astro";
import TableOfContents from "./notion-blocks/TableOfContents.astro";
import NImage from "./notion-blocks/embeds/NImage.astro";
import NAudio from "./notion-blocks/embeds/NAudio.astro";
import Video from "./notion-blocks/embeds/Video.astro";
import NCode from "./notion-blocks/NCode.astro";
import Quote from "./notion-blocks/Quote.astro";
import Equation from "./notion-blocks/Equation.astro";
import Callout from "./notion-blocks/Callout.astro";
import Embed from "./notion-blocks/embeds/Embed.astro";
import Bookmark from "./notion-blocks/embeds/Bookmark.astro";
import Divider from "./notion-blocks/Divider.astro";
import Table from "./notion-blocks/Table.astro";
import ColumnList from "./notion-blocks/ColumnList.astro";
import BulletedListItems from "./notion-blocks/BulletedListItems.astro";
import NumberedListItems from "./notion-blocks/NumberedListItems.astro";
import ToDo from "./notion-blocks/ToDo.astro";
import SyncedBlock from "./notion-blocks/SyncedBlock.astro";
import Toggle from "./notion-blocks/Toggle.astro";
import File from "./notion-blocks/File.astro";
import LinkToPage from "./notion-blocks/LinkToPage.astro";

export interface Props {
	blocks: interfaces.Block[];
	isRoot?: boolean;
	level?: number;
	headings?: interfaces.Block[];
	renderChildren?: boolean;
	setId?: boolean;
}

const {
	blocks: rawBlocks,
	isRoot = false,
	level = 1,
	headings: rawHeadings = [],
	renderChildren = true,
	setId = true,
} = Astro.props;

const blocks = rawBlocks.reduce(
	(arr: (interfaces.Block | interfaces.List)[], block: interfaces.Block, i: number) => {
		const isBulletedListItem = block.Type === "bulleted_list_item";
		const isNumberedListItem = block.Type === "numbered_list_item";
		const isToDo = block.Type === "to_do";

		if (!isBulletedListItem && !isNumberedListItem && !isToDo) {
			return [...arr, block];
		}

		let listType: interfaces.ListType;
		if (isBulletedListItem) {
			listType = "bulleted_list";
		} else if (isNumberedListItem) {
			listType = "numbered_list";
		} else {
			listType = "to_do_list";
		}

		if (i === 0) {
			const list: interfaces.List = {
				Type: listType,
				ListItems: [block],
			};
			return [...arr, list];
		}

		const prevItem = arr[arr.length - 1];
		if (!prevItem) {
			const list: interfaces.List = {
				Type: listType,
				ListItems: [block],
			};
			return [...arr, list];
		}
		const prevList = "ListItems" in prevItem ? (prevItem as interfaces.List) : null;

		if (
			!prevList ||
			(isBulletedListItem && prevList.Type !== "bulleted_list") ||
			(isNumberedListItem && prevList.Type !== "numbered_list") ||
			(isToDo && prevList.Type !== "to_do_list")
		) {
			const list: interfaces.List = {
				Type: listType,
				ListItems: [block],
			};
			return [...arr, list];
		}

		prevList.ListItems.push(block);

		return arr;
	},
	[] as (interfaces.Block | interfaces.List)[],
);

let headings = rawHeadings;
if (isRoot) {
	headings = blocks.filter(
		(b): b is interfaces.Block =>
			"Id" in b && ["heading_1", "heading_2", "heading_3"].includes(b.Type),
	);
}

const bookmarkURLs = blocks
	.filter(
		(b): b is interfaces.Block =>
			"Type" in b && ["bookmark", "link_preview", "embed"].includes(b.Type),
	)
	.map((b: interfaces.Block) => {
		const urlString = (b.Bookmark || b.LinkPreview || b.Embed)?.Url;
		if (!urlString) return null;

		try {
			return new URL(urlString);
		} catch (err) {
			console.log(err);
			return null;
		}
	})
	.filter((url): url is URL => url !== null && !isTweetURL(url) && !isAmazonURL(url));

const bookmarkURLMap = await buildURLToHTMLMap(bookmarkURLs);
---

{
	blocks.map((block) => {
		switch (block.Type) {
			case "paragraph":
				return (
					<Paragraph
						block={block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "heading_1":
				return (
					<Heading1
						block={block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "heading_2":
				return (
					<Heading2
						block={block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "heading_3":
				return (
					<Heading3
						block={block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "table_of_contents":
				return <TableOfContents block={block} headings={headings} setId={setId} />;
			case "image":
				return <NImage block={block} setId={setId} />;
			case "video":
				return <Video block={block} setId={setId} />;
			case "audio":
				return <NAudio block={block} setId={setId} />;
			case "code":
				return <NCode block={block} setId={setId} />;
			case "quote":
				return (
					<Quote block={block} headings={headings} renderChildren={renderChildren} setId={setId} />
				);
			case "equation":
				return <Equation block={block} setId={setId} />;
			case "callout":
				return (
					<Callout
						block={block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "embed":
				return <Embed block={block} urlMap={bookmarkURLMap} setId={setId} />;
			case "bookmark":
			case "link_preview":
				return <Bookmark block={block} urlMap={bookmarkURLMap} setId={setId} />;
			case "divider":
				return <Divider />;
			case "table":
				return <Table block={block} setId={setId} />;
			case "column_list":
				return (
					<ColumnList
						block={block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "bulleted_list":
				return (
					<BulletedListItems
						block={block as unknown as interfaces.Block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "numbered_list":
				return (
					<NumberedListItems
						block={block as unknown as interfaces.Block}
						level={level}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "to_do_list":
				return (
					<ToDo
						block={block as unknown as interfaces.Block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "synced_block":
				return (
					<SyncedBlock
						block={block}
						headings={headings}
						renderChildren={renderChildren}
						setId={setId}
					/>
				);
			case "toggle":
				return (
					<Toggle block={block} headings={headings} renderChildren={renderChildren} setId={setId} />
				);
			case "file":
				return <File block={block} setId={setId} />;
			case "link_to_page":
				return <LinkToPage block={block} setId={setId} />;
		}
		return null;
	})
}
